<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crear postulaciÃ³n - MiniChangApp</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="navbar"></div>

  <main>
    <h2>ğŸ“© Crear postulaciÃ³n</h2>

    <form id="formPostulacion">
      <label>
        <span>ğŸ’¼ Trabajo</span>
        <select id="trabajo_id" required>
          <option value="">Seleccionar trabajo...</option>
        </select>
      </label>

      <label>
        <span>ğŸ‘¤ Usuario</span>
        <select id="usuario_id" required>
          <option value="">Seleccionar usuario...</option>
        </select>
      </label>

      <label>
        <span>ğŸ’¬ Mensaje (opcional)</span>
        <textarea id="mensaje" placeholder="Ejemplo: Tengo experiencia en eventos..."></textarea>
      </label>

      <label>
        <span>ğŸ’° Oferta de pago (opcional)</span>
        <input type="number" id="oferta_pago" placeholder="Ejemplo: 25000" />
      </label>

      <button type="submit">âœ¨ Crear postulaciÃ³n</button>
    </form>
  </main>

  <div id="footer"></div>

  <script src="config.js"></script>

  <script>
    // Carga de navbar y footer
    async function loadComponent(id, file) {
      const res = await fetch(file);
      const html = await res.text();
      document.getElementById(id).innerHTML = html;
    }
    loadComponent("navbar", "/components/navbar.html");
    loadComponent("footer", "/components/footer.html");

    // Cargar listas en los select
    async function cargarSelects() {
      const trabajoSelect = document.getElementById("trabajo_id");
      const usuarioSelect = document.getElementById("usuario_id");

      try {
        const [trabajosRes, usuariosRes] = await Promise.all([
          fetch(`${API_URL}/trabajos`),
          fetch(`${API_URL}/usuarios`)
        ]);

        const trabajos = await trabajosRes.json();
        const usuarios = await usuariosRes.json();

        trabajos.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.id_trabajo;
          opt.textContent = t.titulo;
          trabajoSelect.appendChild(opt);
        });

        usuarios.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.id_usuario;
          opt.textContent = u.nombre;
          usuarioSelect.appendChild(opt);
        });
      } catch (err) {
        alert("âŒ Error al cargar listas: " + err.message);
      }
    }

    // Enviar postulaciÃ³n
    document.getElementById("formPostulacion").addEventListener("submit", async (e) => {
      e.preventDefault();
      const trabajo_id = document.getElementById("trabajo_id").value;
      const usuario_id = document.getElementById("usuario_id").value;
      const mensaje = document.getElementById("mensaje").value;
      const oferta_pago = document.getElementById("oferta_pago").value;

      if (!trabajo_id || !usuario_id) {
        return alert("âš ï¸ Debes seleccionar un trabajo y un usuario.");
      }

      const res = await fetch(`${API_URL}/postulaciones`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ trabajo_id, usuario_id, mensaje, oferta_pago })
      });

      if (res.ok) {
        alert("âœ… PostulaciÃ³n creada correctamente.");
        document.getElementById("formPostulacion").reset();
      } else {
        const err = await res.json();
        alert("âŒ Error: " + err.error);
      }
    });

    cargarSelects();
  </script>
</body>
</html>
