trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '22.x'
  azureSubscription: 'azure-for-students'

  # BACKEND
  webAppQA: 'changapp-qa'
  webAppPROD: 'changapp-prod'

  # FRONTEND
  webFrontQA: 'changapp-front-qa'
  webFrontPROD: 'changapp-front-prod'

  # URLS REALES DE AZURE
  qaBackendUrl: 'https://changapp-qa-f2dkejh0dxeshbh4.canadacentral-01.azurewebsites.net'
  prodBackendUrl: 'https://changapp-prod-atcjfjgnbkhde0g2.canadacentral-01.azurewebsites.net'
  qaFrontendUrl: 'https://changapp-front-qa-etdpavbhgdbwh2cj.canadacentral-01.azurewebsites.net'
  prodFrontendUrl: 'https://changapp-front-prod-fefad0hne5ancrd4.canadacentral-01.azurewebsites.net'


stages:

# ===========================
#       BUILD
# ===========================
- stage: Build
  displayName: 'Build and Package'
  jobs:
  - job: BuildJob
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Usar Node.js'

    - script: npm ci
      displayName: 'Instalar dependencias backend'

    # Empaquetar BACKEND
    - task: ArchiveFiles@2
      displayName: 'Empaquetar BACKEND'
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
        replaceExistingArchive: true

    # Empaquetar FRONTEND (solo carpeta /front)
    - task: ArchiveFiles@2
      displayName: 'Empaquetar FRONTEND'
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)/front'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publicar artefacto'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'
        publishLocation: 'Container'


# ===========================
#       TEST
# ===========================
- stage: Test
  dependsOn: Build
  jobs:
  - job: Tests
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'

    - script: |
        echo "Ejecutando tests unitarios..."
        export NODE_ENV=test
        npm ci
        npm test -- --coverage --runInBand
      displayName: "Run Unit Tests"

# ===========================
#     DEPLOY QA
# ===========================
- stage: Deploy_QA
  dependsOn: Test
  jobs:
  - deployment: QADeploy
    environment: 'QA'
    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: drop

          # BACKEND QA
          - task: AzureWebApp@1
            displayName: 'Deploy BACKEND en QA'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webAppQA)
              package: '$(Pipeline.Workspace)/drop/backend.zip'

          - task: AzureAppServiceSettings@1
            displayName: "Variables BACKEND QA"
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: $(webAppQA)
              appSettings: |
                [
                  { "name": "NODE_ENV", "value": "qa" }
                ]

          # FRONTEND QA
          - task: AzureWebApp@1
            displayName: 'Deploy FRONTEND en QA'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webFrontQA)
              package: '$(Pipeline.Workspace)/drop/frontend.zip'

# ===========================
#   E2E TESTS (CYPRESS)
# ===========================
- stage: E2E_Tests
  displayName: 'E2E Tests (Cypress)'
  dependsOn: Deploy_QA
  jobs:
  - job: CypressTests
    displayName: 'Run Cypress E2E Tests'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Usar Node.js'

    - script: npm ci
      displayName: 'Instalar dependencias'

    # HEALTH CHECK CON URLs CORRECTAS
    - script: |
        echo "üîç Verificando disponibilidad de QA..."
        echo "Backend: $(qaBackendUrl)"
        echo "Frontend: $(qaFrontendUrl)"
        echo ""
        
        # Funci√≥n para verificar URL
        check_url() {
          url=$1
          name=$2
          echo "Verificando $name..."
          
          http_code=$(curl -s -o /dev/null -w "%{http_code}" "$url" 2>/dev/null || echo "000")
          echo "  HTTP Code: $http_code"
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "301" ] || [ "$http_code" = "302" ]; then
            echo "  ‚úÖ $name responde!"
            return 0
          else
            echo "  ‚ùå $name NO responde (c√≥digo: $http_code)"
            return 1
          fi
        }
        
        # Espera inicial (Azure cold start puede tardar)
        echo "‚è≥ Esperando 45 segundos para que Azure inicie las apps..."
        sleep 45
        
        # Verificar Backend
        echo ""
        echo "=== VERIFICANDO BACKEND ==="
        max_attempts=15
        attempt=0
        backend_ok=false
        
        while [ $attempt -lt $max_attempts ]; do
          echo "Intento $((attempt+1))/$max_attempts..."
          
          if check_url "$(qaBackendUrl)/health" "Backend /health"; then
            backend_ok=true
            break
          fi
          
          sleep 4
          attempt=$((attempt+1))
        done
        
        if [ "$backend_ok" = false ]; then
          echo "‚ö†Ô∏è Backend /health no responde, probando ruta ra√≠z..."
          if check_url "$(qaBackendUrl)" "Backend /"; then
            backend_ok=true
            echo "‚úÖ Backend responde en ruta ra√≠z"
          fi
        fi
        
        # Verificar Frontend
        echo ""
        echo "=== VERIFICANDO FRONTEND ==="
        attempt=0
        frontend_ok=false
        
        while [ $attempt -lt $max_attempts ]; do
          echo "Intento $((attempt+1))/$max_attempts..."
          
          if check_url "$(qaFrontendUrl)" "Frontend"; then
            frontend_ok=true
            break
          fi
          
          sleep 4
          attempt=$((attempt+1))
        done
        
        # Resultado final
        echo ""
        echo "=== RESULTADO ==="
        echo "Backend: $backend_ok"
        echo "Frontend: $frontend_ok"
        
        if [ "$frontend_ok" = false ]; then
          echo ""
          echo "‚ùå ERROR: Frontend NO est√° disponible"
          echo ""
          echo "Debug detallado del Frontend:"
          curl -v "$(qaFrontendUrl)" 2>&1 | head -30
          echo ""
          echo "Debug detallado del Backend:"
          curl -v "$(qaBackendUrl)" 2>&1 | head -30
          exit 1
        fi
        
        if [ "$backend_ok" = false ]; then
          echo "‚ö†Ô∏è Backend no responde completamente, pero continuamos (Cypress puede necesitar ajustes)"
        fi
        
        echo ""
        echo "‚úÖ Frontend est√° disponible!"
        echo "Esperando 15 segundos adicionales por seguridad..."
        sleep 15
        
      displayName: 'Health Check QA'
      continueOnError: false

    - script: |
        echo "üß™ Ejecutando Cypress E2E Tests..."
        echo "Base URL: $(qaFrontendUrl)"
        echo "API URL: $(qaBackendUrl)"
      displayName: 'Info de test'

    - script: |
        npm run cypress:ci -- --config baseUrl=$(qaFrontendUrl)
      displayName: 'Run Cypress Tests'
      env:
        CYPRESS_BASE_URL: $(qaFrontendUrl)
        CYPRESS_API_URL: $(qaBackendUrl)

    - task: PublishTestResults@2
      displayName: 'Publicar resultados Cypress'
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'cypress/results/*.xml'
        failTaskOnFailedTests: true
        testRunTitle: 'Cypress E2E Tests'

    - task: PublishBuildArtifacts@1
      displayName: 'Publicar screenshots (si fall√≥)'
      condition: failed()
      inputs:
        pathToPublish: 'cypress/screenshots'
        artifactName: 'cypress-screenshots'

# ===========================
#     DEPLOY PROD
# ===========================
- stage: Deploy_PROD
  dependsOn: E2E_Tests  # ‚Üê CAMBIO: Ahora depende de E2E
  jobs:
  - deployment: ProdDeploy
    environment: 'PROD'
    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: drop

          # BACKEND PROD
          - task: AzureWebApp@1
            displayName: 'Deploy BACKEND en PROD'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webAppPROD)
              package: '$(Pipeline.Workspace)/drop/backend.zip'

          - task: AzureAppServiceSettings@1
            displayName: "Variables BACKEND PROD"
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: $(webAppPROD)
              appSettings: |
                [
                  { "name": "NODE_ENV", "value": "production" }
                ]

          # FRONTEND PROD
          - task: AzureWebApp@1
            displayName: 'Deploy FRONTEND en PROD'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webFrontPROD)
              package: '$(Pipeline.Workspace)/drop/frontend.zip'