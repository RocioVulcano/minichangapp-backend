trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '22.x'
  azureSubscription: 'azure-for-students'

  # WebApps correctas
  webAppQA: 'changapp-qa'
  webAppPROD: 'changapp-prod'

stages:

# ===========================
#       STAGE 1: BUILD
# ===========================
- stage: Build
  displayName: 'Build and Package'
  jobs:
  - job: BuildJob
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Usar Node.js'

    - script: npm ci
      displayName: 'Instalar dependencias'

    - task: ArchiveFiles@2
      displayName: 'Empaquetar aplicaci√≥n'
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/MiniChangApp.zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publicar artefacto'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'
        publishLocation: 'Container'


# ===========================
#       STAGE 2: TEST
# ===========================
- stage: Test
  dependsOn: Build
  jobs:
  - job: Tests
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'

    - script: |
        echo "Ejecutando tests ..."
        npm ci
        npm test -- --coverage --runInBand
      displayName: "Run tests"


# ===========================
#     STAGE 3: DEPLOY QA
# ===========================
- stage: Deploy_QA
  dependsOn: Test
  jobs:
  - deployment: QADeploy
    environment: 'QA'
    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: 'Deploy en QA'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webAppQA)
              package: '$(Pipeline.Workspace)/drop/MiniChangApp.zip'

          - task: AzureWebApp@1
            displayName: "Variables QA"
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webAppQA)
              appSettings: |
                NODE_ENV=qa
                SUPABASE_URL=$(SUPABASE_URL)
                SUPABASE_KEY=$(SUPABASE_KEY)


# ===========================
#    STAGE 4: DEPLOY PROD
# ===========================
- stage: Deploy_PROD
  dependsOn: Deploy_QA
  jobs:
  - deployment: ProdDeploy
    environment: 'PROD'
    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: 'Deploy en PROD'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webAppPROD)
              package: '$(Pipeline.Workspace)/drop/MiniChangApp.zip'

          - task: AzureWebApp@1
            displayName: "Variables PROD"
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webAppPROD)
              appSettings: |
                NODE_ENV=production
                DATABASE_URL_PROD=$(DATABASE_URL_PROD)
