<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trabajos - MiniChangApp</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="navbar"></div>

  <main>
    <h2>ğŸ’¼ Lista de trabajos</h2>
    <div id="loading" style="text-align: center; padding: 40px;">
      <div class="loading"></div>
      <p style="margin-top: 15px; color: #666;">Cargando trabajos...</p>
    </div>
    <ul id="lista" style="display: none;"></ul>
  </main>

  <div id="footer"></div>

  <script src="config.js"></script>

  <script>
    // Carga de navbar y footer
    async function loadComponent(id, file) {
      const res = await fetch(file);
      const html = await res.text();
      document.getElementById(id).innerHTML = html;
    }
    loadComponent("navbar", "/components/navbar.html");
    loadComponent("footer", "/components/footer.html");

    // Cargar trabajos
    async function cargarTrabajos() {
      try {
        const res = await fetch(`${API_URL}/trabajos`);
        const trabajos = await res.json();
        const lista = document.getElementById("lista");
        const loading = document.getElementById("loading");

        if (!Array.isArray(trabajos) || trabajos.length === 0) {
          loading.innerHTML = '<p style="color: #999; text-align: center;">No hay trabajos disponibles aÃºn ğŸ˜”</p>';
          return;
        }

        loading.style.display = 'none';
        lista.style.display = 'grid';

        lista.innerHTML = trabajos.map(t => `
          <li>
            <b>${t.titulo}</b>
            <div style="margin-top: 10px; color: #666; font-size: 14px;">
              ${t.descripcion || 'Sin descripciÃ³n'}
            </div>
            <div style="margin-top: 10px; color: #888; font-size: 14px;">
              ğŸ“ ${t.ubicacion}
            </div>
            <div style="margin-top: 10px; color: #999; font-size: 13px;">
              ğŸ‘¤ Empleador: <strong>${t.empleador?.nombre || 'Desconocido'}</strong>
            </div>
            <div style="margin-top: 10px;">
              <button onclick="editarTrabajo(${t.id_trabajo}, '${t.titulo}', '${t.descripcion || ''}', '${t.ubicacion || ''}', '${t.empleador?.id_usuario || ''}')">âœï¸ Editar</button>
              <button onclick="eliminarTrabajo(${t.id_trabajo})" style="background:#ff4d4f;">ğŸ—‘ Eliminar</button>
            </div>
          </li>
        `).join("");
      } catch (error) {
        document.getElementById("loading").innerHTML =
          '<p style="color: red; text-align: center;">âŒ Error al cargar trabajos. Verifica que el servidor estÃ© ejecutÃ¡ndose.</p>';
      }
    }

    // Editar trabajo
    function editarTrabajo(id, titulo, descripcion, ubicacion, empleador_id) {
      const nuevoTitulo = prompt("Nuevo tÃ­tulo:", titulo);
      const nuevaDescripcion = prompt("Nueva descripciÃ³n:", descripcion);
      const nuevaUbicacion = prompt("Nueva ubicaciÃ³n:", ubicacion);
      const nuevoEmpleador = prompt("Nuevo ID de empleador:", empleador_id);
      if (!nuevoTitulo || !nuevaDescripcion || !nuevaUbicacion || !nuevoEmpleador) return alert("âš ï¸ Campos incompletos.");

      fetch(`${API_URL}/trabajos/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          titulo: nuevoTitulo,
          descripcion: nuevaDescripcion,
          ubicacion: nuevaUbicacion,
          empleador_id: nuevoEmpleador
        })
      })
      .then(() => {
        alert("âœ… Trabajo actualizado correctamente.");
        location.reload();
      });
    }

    // Eliminar trabajo
    async function eliminarTrabajo(id) {
      if (!confirm("Â¿Eliminar este trabajo?")) return;
      await fetch(`${API_URL}/trabajos/${id}`, { method: "DELETE" });
      alert("âœ… Trabajo eliminado correctamente.");
      location.reload();
    }

    cargarTrabajos();
  </script>
</body>
</html>
