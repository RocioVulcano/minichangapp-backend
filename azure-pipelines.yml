trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '22.x'
  azureSubscription: 'azure-for-students'

  # BACKEND
  webAppQA: 'changapp-qa'
  webAppPROD: 'changapp-prod'

  # FRONTEND
  webFrontQA: 'changapp-front-qa'
  webFrontPROD: 'changapp-front-prod'

stages:

# ===========================
#       BUILD
# ===========================
- stage: Build
  displayName: 'Build and Package'
  jobs:
  - job: BuildJob
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Usar Node.js'

    - script: npm ci
      displayName: 'Instalar dependencias backend'

    # Empaquetar BACKEND
    - task: ArchiveFiles@2
      displayName: 'Empaquetar BACKEND'
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
        replaceExistingArchive: true

    # Empaquetar FRONTEND (solo carpeta /front)
    - task: ArchiveFiles@2
      displayName: 'Empaquetar FRONTEND'
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)/front'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publicar artefacto'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'
        publishLocation: 'Container'


# ===========================
#       TEST
# ===========================
- stage: Test
  dependsOn: Build
  jobs:
  - job: Tests
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'

    - script: |
        echo "Ejecutando tests ..."
        export NODE_ENV=test
        npm ci
        npm test -- --coverage --runInBand
      displayName: "Run tests"

# ===========================
#       STAGE: CYPRESS E2E
# ===========================
- stage: E2E_Tests
  dependsOn: Test
  displayName: "Pruebas E2E con Cypress"
  jobs:
  - job: Cypress
    displayName: "Ejecutar Cypress E2E"
    pool:
      vmImage: 'ubuntu-latest'

    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: "Usar Node.js"

    - script: npm ci
      displayName: "Instalar dependencias"

    - script: |
        echo "Exportando variables de entorno..."
        export SUPABASE_URL="$SUPABASE_URL"
        export SUPABASE_KEY="$SUPABASE_KEY"

        echo "Variables exportadas"
        
        # Levantar el backend en background
        nohup npm start &
        
        echo "Esperando que el backend responda en http://localhost:3000..."
        
        # Esperar hasta que responda
        for i in {1..20}; do
          if curl -s http://localhost:3000 > /dev/null; then
            echo "Backend levantado ✔"
            break
          fi
          echo "Backend no responde aún... reintentando..."
          sleep 3
        done
        
        # Último intento
        if ! curl -s http://localhost:3000 > /dev/null; then
          echo "❌ ERROR: Backend nunca levantó"
          exit 1
        fi
      displayName: "Exportar entorno + Levantar backend"

    - script: |
        echo "Ejecutando Cypress..."
        npm run cypress:run
      displayName: "Ejecutar Cypress tests"

    - task: PublishTestResults@2
      condition: succeededOrFailed()
      inputs:
        testResultsFormat: JUnit
        testResultsFiles: "cypress/results/*.xml"
        failTaskOnFailedTests: false



# ===========================
#     DEPLOY QA
# ===========================
- stage: Deploy_QA
  dependsOn: Test
  jobs:
  - deployment: QADeploy
    environment: 'QA'
    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: drop

          # BACKEND QA
          - task: AzureWebApp@1
            displayName: 'Deploy BACKEND en QA'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webAppQA)
              package: '$(Pipeline.Workspace)/drop/backend.zip'

          - task: AzureAppServiceSettings@1
            displayName: "Variables BACKEND QA"
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: $(webAppQA)
              appSettings: |
                [
                  { "name": "NODE_ENV", "value": "qa" }
                ]

          # FRONTEND QA
          - task: AzureWebApp@1
            displayName: 'Deploy FRONTEND en QA'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webFrontQA)
              package: '$(Pipeline.Workspace)/drop/frontend.zip'


# ===========================
#     DEPLOY PROD
# ===========================
- stage: Deploy_PROD
  dependsOn: Deploy_QA
  jobs:
  - deployment: ProdDeploy
    environment: 'PROD'
    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: drop

          # BACKEND PROD
          - task: AzureWebApp@1
            displayName: 'Deploy BACKEND en PROD'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webAppPROD)
              package: '$(Pipeline.Workspace)/drop/backend.zip'

          - task: AzureAppServiceSettings@1
            displayName: "Variables BACKEND PROD"
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: $(webAppPROD)
              appSettings: |
                [
                  { "name": "NODE_ENV", "value": "production" }
                ]

          # FRONTEND PROD
          - task: AzureWebApp@1
            displayName: 'Deploy FRONTEND en PROD'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: webApp
              appName: $(webFrontPROD)
              package: '$(Pipeline.Workspace)/drop/frontend.zip'
